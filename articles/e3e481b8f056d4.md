---
title: "PostgreSQL ã§é€£æƒ³é…åˆ— (JSON åž‹) ã®å€¤ã‚’é…åˆ—ã§å–å¾—"
emoji: "ðŸ“"
type: "tech"
topics: ["JSON", "PostgreSQL", "SQL"]
published: true
---
`PostgreSQL` ã«æ ¼ç´ã•ã‚ŒãŸ JSON (or JSONB) ã‚«ãƒ©ãƒ ã‹ã‚‰é€£æƒ³é…åˆ— (object) ã®å€¤ã ã‘ã‚’é…åˆ—ã§å–å¾—ã—ãŸã‹ã£ãŸãŒ `JSON_OBJECT_KEYS` ã¯ã‚ã‚‹ã®ã« `JSON_OBJECT_VALUES` ãŒç„¡ã‹ã£ãŸç‚ºã€è‰²ã€…ã¨è©¦ã—ãŸæ™‚ã®ãƒ¡ãƒ¢ã€‚

----

ä¾‹ãˆã°ä¸‹è¨˜ã®ã‚ˆã†ãª JSONB åž‹ã®ã‚«ãƒ©ãƒ ãŒã‚ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”¨æ„ã™ã‚‹ã€‚

```sql
CREATE TABLE hoge (
    id SERIAL NOT NULL,
    data JSONB,
    PRIMARY KEY (id)
) ;
```

```sql
INSERT INTO hoge (data) VALUES ('{ "fuga": { "a": { "id": 1 }, "b": { "id": 2 }, "c": { "id": 3 } } }') ;
INSERT INTO hoge (data) VALUES ('{ "fuga": { "d": { "id": 4 }, "e": { "id": 5 }, "f": { "id": 6 } } }') ;
INSERT INTO hoge (data) VALUES ('{ "fuga": { "g": { "id": 7 }, "h": { "id": 8 }, "i": { "id": 9 } } }') ;
```

```sql
SELECT id, JSONB_PRETTY(data) FROM hoge ;
 id |    jsonb_pretty
----+---------------------
  1 | {                  +
    |     "fuga": {      +
    |         "a": {     +
    |             "id": 1+
    |         },         +
    |         "b": {     +
    |             "id": 2+
    |         },         +
    |         "c": {     +
    |             "id": 3+
    |         }          +
    |     }              +
    | }
  2 | {                  +
    |     "fuga": {      +
    |         "d": {     +
    |             "id": 4+
    |         },         +
    |         "e": {     +
    |             "id": 5+
    |         },         +
    |         "f": {     +
    |             "id": 6+
    |         }          +
    |     }              +
    | }
  3 | {                  +
    |     "fuga": {      +
    |         "g": {     +
    |             "id": 7+
    |         },         +
    |         "h": {     +
    |             "id": 8+
    |         },         +
    |         "i": {     +
    |             "id": 9+
    |         }          +
    |     }              +
    | }
(3 rows)
```

----

## é€£æƒ³é…åˆ—ã® key ã‚’é…åˆ—ã§å–å¾—

é€£æƒ³é…åˆ— (object) ã® key ã‚’é…åˆ—ã§å–å¾—ã—ãŸã„å ´åˆã¯ `JSON_OBJECT_KEYS` ã‚’ä½¿ã„ã€ä¸‹è¨˜ã®ã‚ˆã†ã«å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

```sql
SELECT id, JSON_OBJECT_KEYS((data->>'fuga')::JSON) AS k1 FROM hoge

 id | k1
----+----
  1 | a
  1 | b
  1 | c
  2 | d
  2 | e
  2 | f
  3 | g
  3 | h
  3 | i
(9 rows)
```

key ã”ã¨ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ãƒãƒ©ã‘ã¦å–å¾—ã—ã¦ã‚‚ä½¿ã„ã¥ã‚‰ã„ã®ã§ã€ãã‚Œãžã‚Œã‚’é…åˆ—ã«å¤‰æ›ã™ã‚‹ã€‚

```sql
SELECT id, ARRAY_TO_JSON(ARRAY_AGG(k1)) AS keys
FROM (
  SELECT id, JSON_OBJECT_KEYS((data->>'fuga')::JSON) AS k1 FROM hoge
) AS t1
GROUP BY id
ORDER BY id

 id |      keys
----+---------------
  1 | ["a","b","c"]
  2 | ["d","e","f"]
  3 | ["g","h","i"]
(3 rows)
```

----

## é€£æƒ³é…åˆ—ã® value ã‚’é…åˆ—ã§å–å¾—

é€£æƒ³é…åˆ— (object) ã® value ã‚’é…åˆ—ã§å–å¾—ã—ãŸã„å ´åˆã¯ `JSON_OBJECT_KEYS` ã®ä»£ã‚ã‚Šã¨ãªã‚‹ `JSON_OBJECT_VALUES` ãŒã‚ã‚Œã°è‰¯ã„ã®ã§ã™ãŒã€ä½•æ•…ã‹ç”¨æ„ã•ã‚Œã¦ã„ãªã„ç‚ºã€è‰²ã€…ã¨é–¢æ•°ã‚’é§†ä½¿ã—ã¦å®Ÿç¾ã‚’è©¦ã¿ãŸçµæžœãŒä»¥ä¸‹ã®é€šã‚Šã€‚

```sql
SELECT id, JSON_EACH((data->>'fuga')::JSON) AS v1 FROM hoge ;

 id |         v1
----+-------------------
  1 | (a,"{""id"": 1}")
  1 | (b,"{""id"": 2}")
  1 | (c,"{""id"": 3}")
  2 | (d,"{""id"": 4}")
  2 | (e,"{""id"": 5}")
  2 | (f,"{""id"": 6}")
  3 | (g,"{""id"": 7}")
  3 | (h,"{""id"": 8}")
  3 | (i,"{""id"": 9}")
(9 rows)
```

```sql
SELECT id, ROW_TO_JSON(JSON_EACH((data->>'fuga')::JSON)) AS v1 FROM hoge ;

 id |              v1
----+-------------------------------
  1 | {"key":"a","value":{"id": 1}}
  1 | {"key":"b","value":{"id": 2}}
  1 | {"key":"c","value":{"id": 3}}
  2 | {"key":"d","value":{"id": 4}}
  2 | {"key":"e","value":{"id": 5}}
  2 | {"key":"f","value":{"id": 6}}
  3 | {"key":"g","value":{"id": 7}}
  3 | {"key":"h","value":{"id": 8}}
  3 | {"key":"i","value":{"id": 9}}
(9 rows)
```

```sql
SELECT id, ROW_TO_JSON(JSON_EACH((data->>'fuga')::JSON))->>'value' AS v1 FROM hoge ;

 id |    v1
----+-----------
  1 | {"id": 1}
  1 | {"id": 2}
  1 | {"id": 3}
  2 | {"id": 4}
  2 | {"id": 5}
  2 | {"id": 6}
  3 | {"id": 7}
  3 | {"id": 8}
  3 | {"id": 9}
(9 rows)
```

```sql
SELECT id, ARRAY_TO_JSON(ARRAY_AGG(v1::JSON)) AS values
FROM (
  SELECT id, ROW_TO_JSON(JSON_EACH((data->>'fuga')::JSON))->>'value' AS v1 FROM hoge
) AS t1
GROUP BY id
ORDER BY id

 id |             values
----+---------------------------------
  1 | [{"id": 1},{"id": 2},{"id": 3}]
  2 | [{"id": 4},{"id": 5},{"id": 6}]
  3 | [{"id": 7},{"id": 8},{"id": 9}]
(3 rows)
```
