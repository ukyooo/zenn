---
title: "æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚ã‚‹ AWS EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ¬ãƒ³ã‚¸ã‚’å–å¾—ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ˜Š"
type: "tech"
topics: ["curl", "jq", "JSON", "AWS", "CLI"]
published: true
---
ã‚ã¾ã‚Šéœ€è¦ãŒç„¡ã•ãã†ã ã‘ã©ã€ãŸã¾ãŸã¾æ²é¡Œã®ä»¶ã‚’çŸ¥ã‚‹å¿…è¦ãŒã‚ã£ãŸã®ã§ã€ãƒ¡ãƒ¢ã€‚

`curl` ã¨ `jq` ã‚’ä½¿ç”¨ã—ã¦ã€ä¸‹è¨˜ã®ã‚ˆã†ã«å®Ÿè¡Œã™ã‚‹ã€‚

```
curl -s -X GET https://ip-ranges.amazonaws.com/ip-ranges.json \
  | jq -r '.prefixes[]
    | select (.region == "ap-northeast-1")
    | select (.service == "EC2")
    | .ip_prefix' \
;
```



----

## è£œè¶³èª¬æ˜

### AWS ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹ ãƒ¬ãƒ³ã‚¸ æƒ…å ± å–å¾—

* [ip-ranges.json](https://ip-ranges.amazonaws.com/ip-ranges.json) ã«ã¦ AWS ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹ ãƒ¬ãƒ³ã‚¸ æƒ…å ±ã‚’å…¬é–‹ã—ã¦ã„ã‚‹ã®ã§åˆ©ç”¨ã™ã‚‹ã€‚
	* å‚è€ƒ : [AWS IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¯„å›²](https://docs.aws.amazon.com/ja_jp/general/latest/gr/aws-ip-ranges.html)

```
$ curl -s -X GET https://ip-ranges.amazonaws.com/ip-ranges.json

{
  "syncToken": "1464030365",
  "createDate": "2016-05-23-19-22-21",
  "prefixes": [
    {
      "ip_prefix": "23.20.0.0/14",
      "region": "us-east-1",
      "service": "AMAZON"
    },
    ...
```



### JSON å½¢å¼ã®æƒ…å ±ã‹ã‚‰å¿…è¦ãªæƒ…å ±ã®ã¿æŠ½å‡º

* `jq` ã‚³ãƒãƒ³ãƒ‰ã‚’åˆ©ç”¨ã—ã¦ `prefixes` ã¨ã„ã† key ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹é…åˆ—ã® value ã®ã¿æŠ½å‡ºã™ã‚‹ã€‚
	* å‚è€ƒ : [jq](https://stedolan.github.io/jq/)

```
$ curl -s -X GET https://ip-ranges.amazonaws.com/ip-ranges.json | jq '.prefixes[]'

{
  "ip_prefix": "23.20.0.0/14",
  "region": "us-east-1",
  "service": "AMAZON"
}
{
  "ip_prefix": "27.0.0.0/22",
  "region": "ap-northeast-1",
  "service": "AMAZON"
}
...
```



### æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ `(=ap-northeast-1)` ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

* `select (.region == "ap-northeast-1")` ã¨ã„ã†å…·åˆã« filter ã‚’æ›ã‘ã‚‹ã€‚

```
$ curl -s -X GET https://ip-ranges.amazonaws.com/ip-ranges.json | jq '.prefixes[] | select (.region == "ap-northeast-1")'

{
  "ip_prefix": "27.0.0.0/22",
  "region": "ap-northeast-1",
  "service": "AMAZON"
}
...
{
  "ip_prefix": "46.51.224.0/19",
  "region": "ap-northeast-1",
  "service": "EC2"
}
...
{
  "ip_prefix": "54.248.220.0/26",
  "region": "ap-northeast-1",
  "service": "ROUTE53_HEALTHCHECKS"
}
```



### `EC2` ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

* `select (.service == "EC2")` ã¨ã„ã†å…·åˆã« filter ã‚’æ›ã‘ã‚‹ã€‚

```
$ curl -s -X GET https://ip-ranges.amazonaws.com/ip-ranges.json | jq '.prefixes[] | select (.region == "ap-northeast-1") | select (.service == "EC2")'

{
  "ip_prefix": "46.51.224.0/19",
  "region": "ap-northeast-1",
  "service": "EC2"
}
{
  "ip_prefix": "52.68.0.0/15",
  "region": "ap-northeast-1",
  "service": "EC2"
}
{
  "ip_prefix": "52.95.243.0/24",
  "region": "ap-northeast-1",
  "service": "EC2"
}
...
```



### IP ã‚¢ãƒ‰ãƒ¬ã‚¹ ãƒ¬ãƒ³ã‚¸ æƒ…å ±ã®ã¿ã‚’æŠ½å‡º

* ä»Šå›å¿…è¦ãªæƒ…å ±ã®ã¿ã‚’æŠ½å‡ºã™ã‚‹ã€‚

```
$ curl -s -X GET https://ip-ranges.amazonaws.com/ip-ranges.json | jq '.prefixes[] | select (.region == "ap-northeast-1") | select (.service == "EC2") | .ip_prefix'

"46.51.224.0/19"
"52.68.0.0/15"
"52.95.243.0/24"
"52.95.255.48/28"
"52.192.0.0/15"
"52.196.0.0/14"
"54.64.0.0/15"
"54.92.0.0/17"
"54.95.0.0/16"
"54.150.0.0/16"
"54.168.0.0/16"
"54.178.0.0/16"
"54.199.0.0/16"
"54.238.0.0/16"
"54.248.0.0/15"
"54.250.0.0/16"
"103.4.8.0/21"
"175.41.192.0/18"
"176.32.64.0/19"
"176.34.0.0/19"
"176.34.32.0/19"
```



### `"` (ãƒ€ãƒ–ãƒ«ã‚³ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³) é™¤å»

* `"` (ãƒ€ãƒ–ãƒ«ã‚³ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³) ãŒä¸è¦ãªå ´åˆã¯ `jq` ã‚³ãƒãƒ³ãƒ‰ã« `-r` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã™ã‚‹ã€‚

```
$ curl -s -X GET https://ip-ranges.amazonaws.com/ip-ranges.json | jq -r '.prefixes[] | select (.region == "ap-northeast-1") | select (.service == "EC2") | .ip_prefix'

46.51.224.0/19
52.68.0.0/15
52.95.243.0/24
52.95.255.48/28
52.192.0.0/15
52.196.0.0/14
54.64.0.0/15
54.92.0.0/17
54.95.0.0/16
54.150.0.0/16
54.168.0.0/16
54.178.0.0/16
54.199.0.0/16
54.238.0.0/16
54.248.0.0/15
54.250.0.0/16
103.4.8.0/21
175.41.192.0/18
176.32.64.0/19
176.34.0.0/19
176.34.32.0/19
```



----

## ãŠã¾ã‘

`AWS CLI` ã‚’ä½¿ç”¨ã—ã¦ Security Group ã« `https` ã‚’é€šã™å¯¾å¿œã‚’ã™ã‚‹å ´åˆã€‚

å‚è€ƒ : [aws ec2 authorize-security-group-ingress](http://docs.aws.amazon.com/cli/latest/reference/ec2/authorize-security-group-ingress.html)

```
#!/bin/bash

AWS_SECURITY_GROUP_ID="sg-xxxxxxxx"
for CIDR in $(curl -s -X GET https://ip-ranges.amazonaws.com/ip-ranges.json | jq -r '.prefixes[] | select (.region == "ap-northeast-1") | select (.service == "EC2") | .ip_prefix'); do
  aws ec2 authorize-security-group-ingress --group-id $AWS_SECURITY_GROUP_ID --protocol tcp --port 443 --cidr $CIDR
done

exit 0
```
